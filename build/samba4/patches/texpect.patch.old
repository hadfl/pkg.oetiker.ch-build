--- a/lib/texpect/texpect.c
+++ b/lib/texpect/texpect.c
@@ -62,6 +62,7 @@
 #include <popt.h>
 #include <errno.h>
 #include <err.h>
+#include <signal.h>
 
 struct command {
 	enum { CMD_EXPECT = 0, CMD_SEND, CMD_PASSWORD } type;
--- a/lib/texpect/texpect.c
+++ b/lib/texpect/texpect.c
@@ -31,20 +31,10 @@
  * SUCH DAMAGE.
  */
 
-#include "config.h"
+#include "replace.h"
+#include "system/filesys.h"
+#include "system/wait.h"
 
-#ifndef HAVE_SYS_TYPES_H
-#include <sys/types.h>
-#endif
-#ifdef HAVE_SYS_WAIT_H
-#include <sys/wait.h>
-#endif
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#ifdef HAVE_UNISTD_H
-#include <unistd.h>
-#endif
 #ifdef HAVE_PTY_H
 #include <pty.h>
 #endif
@@ -60,9 +50,7 @@
 #endif /* STREAMPTY */
 
 #include <popt.h>
-#include <errno.h>
 #include <err.h>
-#include <signal.h>
 
 struct command {
 	enum { CMD_EXPECT = 0, CMD_SEND, CMD_PASSWORD } type;
--- a/lib/texpect/texpect.c
+++ b/lib/texpect/texpect.c
@@ -358,8 +358,9 @@ int main(int argc, const char **argv)
 	pid_t pid;
 	poptContext pc;
 	const char *instruction_file;
+	const char **args;
 	const char *program;
-	char* const *program_args;
+	char * const *program_args;
 
 	pc = poptGetContext("texpect",
 			    argc,
@@ -377,7 +378,8 @@ int main(int argc, const char **argv)
 	}
 
 	instruction_file = poptGetArg(pc);
-	program_args = poptGetArgs(pc);
+	args = poptGetArgs(pc);
+	program_args = (char * const *)discard_const_p(char *, args);
 	program = program_args[0];
 
 	if (opt_verbose) {
--- a/lib/texpect/texpect.c
+++ b/lib/texpect/texpect.c
@@ -41,7 +41,9 @@
 #ifdef HAVE_UTIL_H
 #include <util.h>
 #endif
-#ifdef HAVE_LIBUTIL_H
+#ifdef HAVE_BSD_LIBUTIL_H
+#include <bsd/libutil.h>
+#elif defined HAVE_LIBUTIL_H
 #include <libutil.h>
 #endif
--- a/lib/texpect/wscript
+++ b/lib/texpect/wscript
@@ -1,7 +1,7 @@
 #!/usr/bin/env python
 
 def configure(conf):
-    conf.CHECK_FUNCS_IN('openpty', 'util', checklibc=True, headers='pty.h util.h libutil.h')
+    conf.CHECK_FUNCS_IN('openpty', 'util', checklibc=True, headers='pty.h util.h bsd/libutil.h libutil.h')
 
 def build(bld):
     bld.SAMBA_BINARY('texpect', 'texpect.c', deps='popt util', install=False)
--- a/lib/texpect/texpect.c
+++ b/lib/texpect/texpect.c
@@ -52,7 +52,12 @@
 #endif /* STREAMPTY */
 
 #include <popt.h>
+
+#ifdef HAVE_ERR_H
 #include <err.h>
+#else
+#include <ccan/err/err.h>
+#endif
 
 struct command {
 	enum { CMD_EXPECT = 0, CMD_SEND, CMD_PASSWORD } type;
--- a/lib/texpect/wscript
+++ b/lib/texpect/wscript
@@ -4,4 +4,4 @@ def configure(conf):
     conf.CHECK_FUNCS_IN('openpty', 'util', checklibc=True, headers='pty.h util.h bsd/libutil.h libutil.h')
 
 def build(bld):
-    bld.SAMBA_BINARY('texpect', 'texpect.c', deps='popt util', install=False)
+    bld.SAMBA_BINARY('texpect', 'texpect.c', deps='popt util ccan', install=False)
